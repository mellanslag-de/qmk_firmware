#include <stdint.h>
#include "color.h"
#include "info_config.h"
#include "layers.h"
#include "moonlander.h"
#include "rgb_matrix.h"
#include "my_keycodes.h"

// @formatter:off
const uint8_t ledmap[][RGB_MATRIX_LED_COUNT][3] = {
    [NAVNUM] = { {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255} },
    [SYMBOLS] = { {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255} },
    [NEO_LAYER_5] = { {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255} },
    [NEO_LAYER_6] = { {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255} },
    [QWERTZ] = { {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242}, {43,251,242} },
    [QWERTZ_GAMING] = { {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255}, {30,255,255} },
    [FN] = { {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {141,255,233}, {0,0,255}, {0,0,255}, {85,203,158}, {85,203,158}, {141,255,233}, {134,255,213}, {85,203,158}, {85,203,158}, {85,203,158}, {32,176,255}, {134,255,213}, {85,203,158}, {85,203,158}, {85,203,158}, {10,225,255}, {134,255,213}, {85,203,158}, {85,203,158}, {85,203,158}, {0,0,255}, {243,222,234}, {243,222,234}, {243,222,234}, {243,222,234}, {243,222,234}, {243,222,234}, {243,222,234}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {134,255,213}, {0,0,255}, {0,0,255}, {141,255,233}, {141,255,233}, {134,255,213}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255}, {134,255,213}, {0,0,255}, {0,0,255}, {0,0,255}, {85,203,158}, {134,255,213}, {0,0,255}, {0,0,255}, {0,0,255}, {85,203,158}, {134,255,213}, {0,0,255}, {0,0,255}, {0,0,255}, {85,203,158}, {32,176,255}, {32,176,255}, {32,176,255}, {32,176,255}, {32,176,255}, {32,176,255}, {32,176,255}, {0,0,255}, {0,0,255}, {0,0,255}, {0,0,255} },
};
// @formatter:on

void set_layer_color(int layer) {
    for (int i = 0; i < RGB_MATRIX_LED_COUNT; i++) {
        HSV hsv = {
            .h = pgm_read_byte(&ledmap[layer][i][0]),
            .s = pgm_read_byte(&ledmap[layer][i][1]),
            .v = pgm_read_byte(&ledmap[layer][i][2]),
        };
        if (!hsv.h && !hsv.s && !hsv.v) {
            rgb_matrix_set_color(i, 0, 0, 0);
        } else {
            RGB rgb = hsv_to_rgb(hsv);
            float f = (float)rgb_matrix_config.hsv.v / UINT8_MAX;
            rgb_matrix_set_color(i, f * rgb.r, f * rgb.g, f * rgb.b);
        }
    }
}

bool rgb__rgb_matrix_indicators_user(void) {
    if (keyboard_config.disable_layer_led) {
        return true;
    }
    switch (biton32(layer_state)) {
        case 4:
            set_layer_color(4);
            break;
        case 5:
            set_layer_color(5);
            break;
        case 6:
            set_layer_color(6);
            break;
        case 7:
            set_layer_color(7);
            break;
        case 8:
            set_layer_color(8);
            break;
        case 9:
            set_layer_color(9);
            break;
        case 10:
            set_layer_color(10);
            break;
        default:
            if (rgb_matrix_get_flags() == LED_FLAG_NONE) rgb_matrix_set_color_all(0, 0, 0);
            break;
    }
    return true;
}

typedef struct {
    uint8_t h; // Hue
    uint8_t s; // Saturation
    uint8_t v; // Value
} hsv_t;

const struct {
    uint16_t keycode;
    hsv_t color;
} keycode_to_color_map[] = {
    {M_RGB_WHITE,  {255, 255, 255}},
    {M_RGB_YELLOW, {255, 255, 1}},
    {M_RGB_ORANGE, {255, 165, 1}},
};

#define KEYCODE_TO_COLOR_MAP_SIZE (sizeof(keycode_to_color_map) / sizeof(keycode_to_color_map[0]))

bool rgb__process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (!record->event.pressed) {
        return true; // Ignore key releases
    }

    // Search for the keycode in the map
    for (size_t i = 0; i < KEYCODE_TO_COLOR_MAP_SIZE; ++i) {
        if (keycode_to_color_map[i].keycode == keycode) {
            rgblight_mode(1);
            rgblight_sethsv_noeeprom(keycode_to_color_map[i].color.h,
                                     keycode_to_color_map[i].color.s,
                                     keycode_to_color_map[i].color.v);
            return false; // Indicate the key was handled
        }
    }

    return true; // Key not found in the map
}
